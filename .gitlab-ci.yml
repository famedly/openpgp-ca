# SPDX-FileCopyrightText: 2019-2020 Heiko Schaefer <heiko@schaefer.name>
# SPDX-License-Identifier: CC0-1.0

image: rust:latest

cache:
  paths:
    - cargo/registry
    - cargo/git

variables:
  CARGO_HOME: $CI_PROJECT_DIR/cargo

before_script:
  - mkdir -p /run/user/$UID
  - apt update -y -qq
  - apt install -y -qq --no-install-recommends  git rustc cargo clang make pkg-config nettle-dev libssl-dev capnproto libsqlite3-dev ca-certificates valgrind strace python3-dev python3-setuptools python3-cffi python3-pytest gnupg
  - apt clean

Cargo test:
  stage: test
  script:
  - cargo test

cargo-fmt:
  script:
    - rustup component add rustfmt
    - cargo fmt -- --check

cargo-clippy:
  script:
    - rustup component add clippy
    - cargo clippy --verbose --tests -- -D warnings
  allow_failure: true

pages:
  image: node:10
  stage: deploy
  before_script:
    - npm install gitbook-cli -g # install gitbook
    - gitbook fetch 3.2.3 # fetch final stable version
    - gitbook install # add any requested plugins in book.json
  script:
    - gitbook build doc/src/ public
  artifacts:
    paths:
      - public
  only:
    - master

#reuse:
#  image:
#    name: fsfe/reuse:latest
#    entrypoint: [""]
#  script:
#    - reuse lint
